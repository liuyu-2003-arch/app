<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰π¶Á≠æÁÆ°ÁêÜÂêéÂè∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        #admin-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
        }

        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #343a40;
            margin-bottom: 25px;
            text-align: center;
        }

        .user-info {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #495057;
            word-break: break-all; /* Ensure long IDs wrap */
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
        }

        .controls button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .group-list {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .group-item {
            border-bottom: 1px solid #e9ecef;
            padding: 15px 20px;
            background-color: #f8f9fa;
        }

        .group-item:last-child {
            border-bottom: none;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.3rem;
            font-weight: 600;
            color: #343a40;
        }

        .group-header-actions button {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: #6c757d;
            margin-left: 10px;
            transition: color 0.2s ease;
        }

        .group-header-actions button:hover {
            color: #343a40;
        }

        .group-header-actions button.delete {
            color: #dc3545;
        }
        .group-header-actions button.delete:hover {
            color: #c82333;
        }

        .bookmark-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: #ffffff;
            border-radius: 8px;
            overflow: hidden; /* For rounded corners on table */
        }

        .bookmark-table th, .bookmark-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .bookmark-table th {
            background-color: #e9ecef;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .bookmark-table tr:last-child td {
            border-bottom: none;
        }

        .bookmark-table td.actions button {
            background: none;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            color: #007bff;
            margin-right: 8px;
            transition: color 0.2s ease;
        }

        .bookmark-table td.actions button:hover {
            color: #0056b3;
        }

        .bookmark-table td.actions button.delete {
            color: #dc3545;
        }
        .bookmark-table td.actions button.delete:hover {
            color: #c82333;
        }

        .bookmark-table .icon-preview {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            object-fit: cover;
            vertical-align: middle;
            margin-right: 8px;
            border: 1px solid #eee;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 550px;
            text-align: center;
            animation: fadeInScale 0.3s ease-out;
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 25px;
            color: #343a40;
            font-size: 1.6rem;
        }

        .modal-content label {
            display: block;
            text-align: left;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
        }

        .modal-content input[type="text"],
        .modal-content input[type="url"],
        .modal-content input[type="file"] {
            width: calc(100% - 24px); /* Account for padding */
            padding: 12px;
            margin-bottom: 18px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .modal-content .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-content button {
            padding: 10px 22px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .modal-content .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .modal-content .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .modal-content .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .modal-content .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
        }

        /* Confirmation Dialog */
        #confirm-dialog .modal-content {
            padding: 25px;
        }
        #confirm-dialog-message {
            font-size: 1.1em;
            margin-bottom: 25px;
            color: #343a40;
        }

        /* Loading Indicator */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            color: #333;
        }

        /* Animations */
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="admin-container">
        <h1>‰π¶Á≠æÁÆ°ÁêÜÂêéÂè∞</h1>
        <div class="user-info">
            ÂΩìÂâçÁî®Êà∑ID: <span id="user-id">Âä†ËΩΩ‰∏≠...</span>
        </div>
        <div class="controls">
            <button id="add-group-btn">Ê∑ªÂä†ÂàÜÁªÑ</button>
        </div>

        <div id="group-list" class="group-list">
            <p id="no-groups-message" class="p-4 text-center text-gray-500 hidden">ÊöÇÊó†ÂàÜÁªÑÔºåËØ∑Ê∑ªÂä†‰∏Ä‰∏™Êñ∞ÂàÜÁªÑ„ÄÇ</p>
        </div>

        <div id="group-modal" class="modal">
            <div class="modal-content">
                <h2 id="group-modal-title">Ê∑ªÂä†Êñ∞ÂàÜÁªÑ</h2>
                <label for="group-name-input">ÂàÜÁªÑÂêçÁß∞:</label>
                <input type="text" id="group-name-input" placeholder="‰æãÂ¶ÇÔºöÊàëÁöÑÂ∑•ÂÖ∑" />
                <div class="modal-buttons">
                    <button id="save-group-btn" class="btn-primary">‰øùÂ≠ò</button>
                    <button class="close-modal btn-secondary">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>

        <div id="bookmark-modal" class="modal">
            <div class="modal-content">
                <h2 id="bookmark-modal-title">Ê∑ªÂä†Êñ∞‰π¶Á≠æ</h2>
                <label for="bookmark-group-select">ÈÄâÊã©ÂàÜÁªÑ:</label>
                <select id="bookmark-group-select" class="w-full p-2 border border-gray-300 rounded-md mb-4"></select>

                <label for="bookmark-name-input">ÂêçÁß∞:</label>
                <input type="text" id="bookmark-name-input" placeholder="‰æãÂ¶ÇÔºöGoogle" />

                <label for="bookmark-url-input">URL:</label>
                <input type="url" id="bookmark-url-input" placeholder="‰æãÂ¶ÇÔºöhttps://www.google.com/" />

                <label for="bookmark-icon-upload">‰∏ä‰º†ÂõæÊ†á (ÂèØÈÄâ):</label>
                <input type="file" id="bookmark-icon-upload" accept="image/*" />
                <div class="modal-buttons">
                    <button id="save-bookmark-btn" class="btn-primary">‰øùÂ≠ò</button>
                    <button class="close-modal btn-secondary">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>

        <div id="confirm-dialog" class="modal">
            <div class="modal-content">
                <p id="confirm-dialog-message"></p>
                <div class="modal-buttons">
                    <button id="confirm-dialog-ok" class="btn-primary">Á°ÆÂÆö</button>
                    <button id="confirm-dialog-cancel" class="btn-secondary">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading-overlay">
        <p>Âä†ËΩΩ‰∏≠...</p>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        try {
            // Attempt to parse the provided firebase config
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Failed to parse __firebase_config. Falling back to default config.", e);
            // If parsing fails, firebaseConfig remains an empty object, which will trigger the default below.
        }

        // Ensure projectId and apiKey are present. If not, provide placeholder values and warn.
        // This is crucial for `initializeApp` to not throw an error and for basic functionality.
        if (!firebaseConfig.projectId || !firebaseConfig.apiKey) {
            console.warn("Firebase 'projectId' or 'apiKey' not found in __firebase_config. Using placeholder values. Please configure your Firebase project correctly in the Canvas environment for data persistence.");
            // Provide a minimal valid config structure to prevent app crash.
            // These placeholders MUST be replaced by the user's actual Firebase project details.
            firebaseConfig = {
                apiKey: firebaseConfig.apiKey || "YOUR_FIREBASE_API_KEY", // Placeholder
                authDomain: firebaseConfig.authDomain || "your-project-id.firebaseapp.com", // Placeholder
                projectId: firebaseConfig.projectId || "your-project-id", // Placeholder
                storageBucket: firebaseConfig.storageBucket || "your-project-id.appspot.com", // Placeholder
                messagingSenderId: firebaseConfig.messagingSenderId || "YOUR_MESSAGING_SENDER_ID", // Placeholder
                appId: firebaseConfig.appId || "YOUR_APP_ID_FROM_FIREBASE_CONSOLE" // Placeholder
            };
        }

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let firebaseGroupsData = []; // Store the latest groups data from Firestore

        const groupListElement = document.getElementById('group-list');
        const addGroupBtn = document.getElementById('add-group-btn');
        const userIdSpan = document.getElementById('user-id');
        const loadingOverlay = document.getElementById('loading-overlay');
        const noGroupsMessage = document.getElementById('no-groups-message');

        // Modal elements
        const groupModal = document.getElementById('group-modal');
        const groupModalTitle = document.getElementById('group-modal-title');
        const groupNameInput = document.getElementById('group-name-input');
        const saveGroupBtn = document.getElementById('save-group-btn');

        const bookmarkModal = document.getElementById('bookmark-modal');
        const bookmarkModalTitle = document.getElementById('bookmark-modal-title');
        const bookmarkGroupSelect = document.getElementById('bookmark-group-select');
        const bookmarkNameInput = document.getElementById('bookmark-name-input');
        const bookmarkUrlInput = document.getElementById('bookmark-url-input');
        const bookmarkIconUpload = document.getElementById('bookmark-icon-upload');
        const saveBookmarkBtn = document.getElementById('save-bookmark-btn');

        const confirmDialog = document.getElementById('confirm-dialog');
        const confirmDialogMessage = document.getElementById('confirm-dialog-message');
        const confirmDialogOkBtn = document.getElementById('confirm-dialog-ok');
        const confirmDialogCancelBtn = document.getElementById('confirm-dialog-cancel');

        let currentEditingGroupDocId = null; // For editing existing groups
        let currentEditingBookmark = null; // For editing existing bookmarks {groupDocId, bookmarkId, data}

        // --- Utility Functions ---

        /**
         * Shows a custom confirmation dialog.
         * @param {string} message - The message to display.
         * @returns {Promise<boolean>} - Resolves true if confirmed, false if cancelled.
         */
        function showConfirmDialog(message) {
            return new Promise((resolve) => {
                confirmDialogMessage.textContent = message;
                confirmDialog.style.display = 'flex';

                const onConfirm = () => {
                    confirmDialog.style.display = 'none';
                    confirmDialogOkBtn.removeEventListener('click', onConfirm);
                    confirmDialogCancelBtn.removeEventListener('click', onCancel);
                    resolve(true);
                };

                const onCancel = () => {
                    confirmDialog.style.display = 'none';
                    confirmDialogOkBtn.removeEventListener('click', onConfirm);
                    confirmDialogCancelBtn.removeEventListener('click', onCancel);
                    resolve(false);
                };

                confirmDialogOkBtn.addEventListener('click', onConfirm);
                confirmDialogCancelBtn.addEventListener('click', onCancel);
            });
        }

        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // --- Firebase Initialization and Authentication ---

        async function initializeFirebase() {
            showLoading();
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdSpan.textContent = userId;
                        isAuthReady = true;
                        console.log("Firebase authenticated. User ID:", userId);
                        setupRealtimeListeners();
                    } else {
                        // Sign in anonymously if no user is logged in
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Signed in with custom token.");
                        } else {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        }
                    }
                    hideLoading();
                });
            } catch (error) {
                console.error("Firebase ÂàùÂßãÂåñÂ§±Ë¥•:", error);
                showConfirmDialog("Firebase ÂàùÂßãÂåñÂ§±Ë¥•: " + error.message);
                hideLoading();
            }
        }

        // --- Firestore Operations ---

        function getGroupsCollectionRef() {
            if (!userId) {
                console.error("User ID is not available.");
                return null;
            }
            // Private data path: /artifacts/{appId}/users/{userId}/{your_collection_name}
            return collection(db, `artifacts/${appId}/users/${userId}/bookmarks`);
        }

        function setupRealtimeListeners() {
            if (!isAuthReady || !userId) return;

            const groupsRef = getGroupsCollectionRef();
            if (!groupsRef) return;

            // Listen for real-time updates to groups
            onSnapshot(query(groupsRef), (snapshot) => {
                firebaseGroupsData = []; // Clear previous data
                snapshot.forEach(doc => {
                    firebaseGroupsData.push({ id: doc.id, ...doc.data() });
                });
                renderGroups(firebaseGroupsData); // Pass the latest data to render
                updateBookmarkGroupSelect(firebaseGroupsData); // Update select options for adding bookmarks
            }, (error) => {
                console.error("ÁõëÂê¨ÂàÜÁªÑÊï∞ÊçÆÂ§±Ë¥•:", error);
                showConfirmDialog("Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆÂ§±Ë¥•: " + error.message);
            });
        }

        async function addOrUpdateGroup(groupName, docId = null) {
            if (!isAuthReady || !userId) return;
            showLoading();
            try {
                const groupsRef = getGroupsCollectionRef();
                if (!groupsRef) return;

                const groupData = { name: groupName };
                if (docId) {
                    await setDoc(doc(groupsRef, docId), groupData, { merge: true });
                    console.log("ÂàÜÁªÑÊõ¥Êñ∞ÊàêÂäü:", groupName);
                } else {
                    // Check if group name already exists before adding
                    const existingGroupsSnapshot = await getDocs(query(groupsRef));
                    const exists = existingGroupsSnapshot.docs.some(d => d.data().name === groupName);
                    if (exists) {
                        showConfirmDialog('ËØ•ÂàÜÁªÑÂêçÁß∞Â∑≤Â≠òÂú®ÔºÅ').then(() => {});
                        hideLoading(); // Hide loading if we return early
                        return;
                    }
                    await setDoc(doc(groupsRef), { name: groupName, items: [] }); // Add with empty items array
                    console.log("ÂàÜÁªÑÊ∑ªÂä†ÊàêÂäü:", groupName);
                }
                groupModal.style.display = 'none';
            } catch (error) {
                console.error("Ê∑ªÂä†/Êõ¥Êñ∞ÂàÜÁªÑÂ§±Ë¥•:", error);
                showConfirmDialog("Êìç‰ΩúÂ§±Ë¥•: " + error.message);
            } finally {
                hideLoading();
            }
        }

        async function deleteGroup(groupDocId, groupName) {
            if (!isAuthReady || !userId) return;

            const confirmed = await showConfirmDialog(`Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁªÑ "${groupName}" ÂèäÂÖ∂ÊâÄÊúâ‰π¶Á≠æÂêóÔºü`);
            if (!confirmed) return;

            showLoading();
            try {
                const groupsRef = getGroupsCollectionRef();
                if (!groupsRef) return;
                await deleteDoc(doc(groupsRef, groupDocId));
                console.log("ÂàÜÁªÑÂà†Èô§ÊàêÂäü:", groupName);
            } catch (error) {
                console.error("Âà†Èô§ÂàÜÁªÑÂ§±Ë¥•:", error);
                showConfirmDialog("Âà†Èô§Â§±Ë¥•: " + error.message);
            } finally {
                hideLoading();
            }
        }

        async function addOrUpdateBookmark(groupDocId, bookmarkData, bookmarkId = null) {
            if (!isAuthReady || !userId) return;
            showLoading();
            try {
                const groupRef = doc(getGroupsCollectionRef(), groupDocId); // Correctly reference the group document by its ID
                const groupDoc = await getDoc(groupRef); // Get the group document snapshot

                if (!groupDoc.exists()) {
                    showConfirmDialog("Êâæ‰∏çÂà∞ÁõÆÊ†áÂàÜÁªÑ„ÄÇ").then(() => {});
                    hideLoading(); // Hide loading if we return early
                    return;
                }
                const currentGroupData = groupDoc.data();
                let items = currentGroupData.items || [];

                // Remove groupName from bookmarkData as it's not stored within the item itself
                const { groupName, ...itemToStore } = bookmarkData;

                if (bookmarkId) {
                    // Update existing bookmark
                    const itemIndex = items.findIndex(item => item.id === bookmarkId);
                    if (itemIndex > -1) {
                        items[itemIndex] = { ...items[itemIndex], ...itemToStore };
                    } else {
                        // This case should ideally not happen if bookmarkId is valid
                        items.push({ id: crypto.randomUUID(), ...itemToStore });
                    }
                } else {
                    // Add new bookmark
                    items.push({ id: crypto.randomUUID(), ...itemToStore });
                }

                await setDoc(groupRef, { items: items }, { merge: true }); // Update the group document
                console.log("‰π¶Á≠æÊ∑ªÂä†/Êõ¥Êñ∞ÊàêÂäü:", bookmarkData.name);
                bookmarkModal.style.display = 'none';
            } catch (error) {
                console.error("Ê∑ªÂä†/Êõ¥Êñ∞‰π¶Á≠æÂ§±Ë¥•:", error);
                showConfirmDialog("Êìç‰ΩúÂ§±Ë¥•: " + error.message);
            } finally {
                hideLoading();
            }
        }

        async function deleteBookmark(groupDocId, bookmarkId, bookmarkName) {
            if (!isAuthReady || !userId) return;

            const confirmed = await showConfirmDialog(`Á°ÆÂÆöË¶ÅÂà†Èô§‰π¶Á≠æ "${bookmarkName}" ÂêóÔºü`);
            if (!confirmed) return;

            showLoading();
            try {
                const groupRef = doc(getGroupsCollectionRef(), groupDocId); // Correctly reference the group document by its ID
                const groupDoc = await getDoc(groupRef); // Get the group document snapshot

                if (!groupDoc.exists()) {
                    showConfirmDialog("Êâæ‰∏çÂà∞ÁõÆÊ†áÂàÜÁªÑ„ÄÇ").then(() => {});
                    hideLoading(); // Hide loading if we return early
                    return;
                }
                const currentGroupData = groupDoc.data();
                let items = currentGroupData.items || [];

                items = items.filter(item => item.id !== bookmarkId);

                await setDoc(groupRef, { items: items }, { merge: true }); // Update the group document
                console.log("‰π¶Á≠æÂà†Èô§ÊàêÂäü:", bookmarkName);
            } catch (error) {
                console.error("Âà†Èô§‰π¶Á≠æÂ§±Ë¥•:", error);
                showConfirmDialog("Âà†Èô§Â§±Ë¥•: " + error.message);
            } finally {
                hideLoading();
            }
        }

        // --- Rendering Functions ---

        function renderGroups(groups) {
            groupListElement.innerHTML = ''; // Clear existing content
            if (groups.length === 0) {
                noGroupsMessage.classList.remove('hidden');
                return;
            } else {
                noGroupsMessage.classList.add('hidden');
            }

            groups.forEach(group => {
                const groupItemDiv = document.createElement('div');
                groupItemDiv.classList.add('group-item');
                groupItemDiv.dataset.groupDocId = group.id; // Store Firestore doc ID on the element

                const groupHeaderDiv = document.createElement('div');
                groupHeaderDiv.classList.add('group-header');
                groupHeaderDiv.innerHTML = `
                    <span>${group.name}</span>
                    <div class="group-header-actions">
                        <button class="add-bookmark-to-group-btn" data-group-doc-id="${group.id}" data-group-name="${group.name}" title="Ê∑ªÂä†‰π¶Á≠æ">‚ûï</button>
                        <button class="edit-group-btn" data-group-doc-id="${group.id}" data-group-name="${group.name}" title="ÁºñËæëÂàÜÁªÑ">‚úé</button>
                        <button class="delete-group-btn delete" data-group-doc-id="${group.id}" data-group-name="${group.name}" title="Âà†Èô§ÂàÜÁªÑ">üóë</button>
                    </div>
                `;
                groupItemDiv.appendChild(groupHeaderDiv);

                const bookmarkTable = document.createElement('table');
                bookmarkTable.classList.add('bookmark-table');
                bookmarkTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>ÂõæÊ†á</th>
                            <th>ÂêçÁß∞</th>
                            <th>URL</th>
                            <th class="w-24">Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                `;
                const tbody = bookmarkTable.querySelector('tbody');

                const items = group.items || [];
                if (items.length === 0) {
                    const noBookmarksRow = document.createElement('tr');
                    noBookmarksRow.innerHTML = `<td colspan="4" class="text-center text-gray-400 py-4">ÊöÇÊó†‰π¶Á≠æ</td>`;
                    tbody.appendChild(noBookmarksRow);
                } else {
                    items.forEach(bookmark => {
                        const bookmarkRow = document.createElement('tr');
                        const faviconUrl = bookmark.icon || `https://www.google.com/s2/favicons?domain=${new URL(bookmark.url).hostname}&sz=32`;
                        const defaultIconHtml = `<div class="w-8 h-8 flex items-center justify-center bg-gray-200 text-gray-600 rounded-md text-xs font-bold">${bookmark.name.charAt(0).toUpperCase()}</div>`;

                        bookmarkRow.innerHTML = `
                            <td>
                                <img src="${faviconUrl}" alt="ÂõæÊ†á" class="icon-preview" onerror="this.onerror=null; this.outerHTML='${defaultIconHtml}';"/>
                            </td>
                            <td>${bookmark.name}</td>
                            <td><a href="${bookmark.url}" target="_blank" class="text-blue-600 hover:underline">${bookmark.url}</a></td>
                            <td class="actions">
                                <button class="edit-bookmark-btn" data-group-doc-id="${group.id}" data-bookmark-id="${bookmark.id}" title="ÁºñËæë">ÁºñËæë</button>
                                <button class="delete-bookmark-btn delete" data-group-doc-id="${group.id}" data-bookmark-id="${bookmark.id}" data-bookmark-name="${bookmark.name}" title="Âà†Èô§">Âà†Èô§</button>
                            </td>
                        `;
                        tbody.appendChild(bookmarkRow);
                    });
                }

                groupItemDiv.appendChild(bookmarkTable);
                groupListElement.appendChild(groupItemDiv);
            });

            // Re-attach event listeners for dynamically created elements
            attachEventListenersToRenderedElements();
        }

        function attachEventListenersToRenderedElements() {
            document.querySelectorAll('.add-bookmark-to-group-btn').forEach(button => {
                button.onclick = () => openBookmarkModal('add', button.dataset.groupDocId, button.dataset.groupName);
            });
            document.querySelectorAll('.edit-group-btn').forEach(button => {
                button.onclick = () => openGroupModal('edit', button.dataset.groupDocId, button.dataset.groupName);
            });
            document.querySelectorAll('.delete-group-btn').forEach(button => {
                button.onclick = () => deleteGroup(button.dataset.groupDocId, button.dataset.groupName);
            });
            document.querySelectorAll('.edit-bookmark-btn').forEach(button => {
                const groupDocId = button.dataset.groupDocId;
                const bookmarkId = button.dataset.bookmarkId;
                // Use the globally available firebaseGroupsData which is updated by onSnapshot
                const groupData = firebaseGroupsData.find(g => g.id === groupDocId);
                const bookmark = groupData ? (groupData.items || []).find(item => item.id === bookmarkId) : null;
                if (bookmark) {
                    button.onclick = () => openBookmarkModal('edit', groupDocId, groupData.name, bookmark);
                } else {
                    console.warn(`Bookmark or group not found for editing: groupDocId=${groupDocId}, bookmarkId=${bookmarkId}`);
                }
            });
            document.querySelectorAll('.delete-bookmark-btn').forEach(button => {
                button.onclick = () => deleteBookmark(button.dataset.groupDocId, button.dataset.bookmarkId, button.dataset.bookmarkName);
            });
        }

        function updateBookmarkGroupSelect(groups) {
            bookmarkGroupSelect.innerHTML = '';
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id; // Use Firestore doc ID for value
                option.textContent = group.name;
                bookmarkGroupSelect.appendChild(option);
            });
        }

        // --- Modal Control Functions ---

        function openGroupModal(mode, docId = null, name = '') {
            groupModal.style.display = 'flex';
            currentEditingGroupDocId = docId;
            if (mode === 'add') {
                groupModalTitle.textContent = 'Ê∑ªÂä†Êñ∞ÂàÜÁªÑ';
                groupNameInput.value = '';
            } else { // edit mode
                groupModalTitle.textContent = 'ÁºñËæëÂàÜÁªÑ';
                groupNameInput.value = name;
            }
            groupNameInput.focus();
        }

        function openBookmarkModal(mode, groupDocId = null, groupName = null, bookmark = null) {
            bookmarkModal.style.display = 'flex';
            currentEditingBookmark = bookmark ? { groupDocId, bookmarkId: bookmark.id, data: bookmark } : null;

            // Populate group select using the latest data from Firestore (firebaseGroupsData is already updated by onSnapshot)
            updateBookmarkGroupSelect(firebaseGroupsData);

            if (mode === 'add') {
                bookmarkModalTitle.textContent = 'Ê∑ªÂä†Êñ∞‰π¶Á≠æ';
                bookmarkNameInput.value = '';
                bookmarkUrlInput.value = '';
                bookmarkIconUpload.value = '';
                if (groupDocId) {
                    bookmarkGroupSelect.value = groupDocId;
                }
            } else { // edit mode
                bookmarkModalTitle.textContent = 'ÁºñËæë‰π¶Á≠æ';
                bookmarkNameInput.value = bookmark.name;
                bookmarkUrlInput.value = bookmark.url;
                bookmarkIconUpload.value = ''; // Clear file input for security/privacy
                bookmarkGroupSelect.value = groupDocId;
            }
            bookmarkNameInput.focus();
        }

        // --- Event Listeners for Modals ---

        saveGroupBtn.addEventListener('click', () => {
            const groupName = groupNameInput.value.trim();
            if (groupName) {
                addOrUpdateGroup(groupName, currentEditingGroupDocId);
            } else {
                showConfirmDialog('ÂàÜÁªÑÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ').then(() => {});
            }
        });

        saveBookmarkBtn.addEventListener('click', async () => {
            const selectedGroupDocId = bookmarkGroupSelect.value;
            const name = bookmarkNameInput.value.trim();
            const url = bookmarkUrlInput.value.trim();
            const iconFile = bookmarkIconUpload.files[0];

            if (!name || !url) {
                showConfirmDialog('ÂêçÁß∞ÂíåURL‰∏çËÉΩ‰∏∫Á©∫ÔºÅ').then(() => {});
                return;
            }
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showConfirmDialog('URLÂøÖÈ°ª‰ª• http:// Êàñ https:// ÂºÄÂ§¥ÔºÅ').then(() => {});
                return;
            }

            let iconData = null;
            if (iconFile) {
                iconData = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(iconFile);
                });
            } else if (currentEditingBookmark && currentEditingBookmark.data.icon && !bookmarkIconUpload.value) {
                // If editing and no new file uploaded, keep existing icon
                iconData = currentEditingBookmark.data.icon;
            }

            // Pass the groupDocId and other bookmark data
            const bookmarkData = { name, url, icon: iconData };

            if (currentEditingBookmark) {
                // Editing existing bookmark
                addOrUpdateBookmark(selectedGroupDocId, bookmarkData, currentEditingBookmark.bookmarkId);
            } else {
                // Adding new bookmark
                addOrUpdateBookmark(selectedGroupDocId, bookmarkData);
            }
        });

        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', (e) => {
                e.target.closest('.modal').style.display = 'none';
            });
        });

        // Close modal if clicked outside
        window.addEventListener('click', (event) => {
            if (event.target === groupModal) {
                groupModal.style.display = "none";
            }
            if (event.target === bookmarkModal) {
                bookmarkModal.style.display = "none";
            }
            // Confirm dialog should not close on outside click
        });

        // Initial Firebase setup
        initializeFirebase();
    </script>
</body>
</html>
